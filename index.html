<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giftinator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #FAF7F2 0%, #F5EFE6 100%);
            color: #3A3632;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 40px 24px;
            width: 100%;
            box-sizing: border-box;
        }

        /* RESPONSIVE: Desktop gets more padding */
        @media (min-width: 768px) {
            .screen {
                padding: 60px 48px;
            }
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* INTRO */
        .intro-screen {
            text-align: center;
            justify-content: center;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        /* RESPONSIVE: Larger text on desktop */
        @media (min-width: 768px) {
            .intro-screen {
                max-width: 700px;
            }
        }

        .brand {
            font-family: 'Cormorant Garamond', serif;
            font-size: 48px;
            font-weight: 700;
            color: #3A3632;
            margin-bottom: 8px;
        }

        /* RESPONSIVE: Bigger brand on desktop */
        @media (min-width: 768px) {
            .brand {
                font-size: 72px;
            }
        }

        .tagline {
            font-size: 15px;
            color: #8B7E74;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 24px;
        }

        .subtitle {
            font-size: 18px;
            line-height: 1.6;
            color: #5A524C;
            margin-bottom: 40px;
        }

        button {
            background: linear-gradient(135deg, #3A3632 0%, #2A2623 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 54, 50, 0.25);
        }

        /* QUIZ */
        .quiz-screen {
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .question-container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        /* RESPONSIVE: Wider on desktop */
        @media (min-width: 768px) {
            .question-container {
                max-width: 700px;
            }
        }

        @media (min-width: 1024px) {
            .question-container {
                max-width: 800px;
            }
        }

        .progress-bar {
            height: 4px;
            background: rgba(58, 54, 50, 0.1);
            border-radius: 2px;
            margin-bottom: 32px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B7E74, #3A3632);
            transition: width 0.4s ease;
        }

        .question-text {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .helper-text {
            font-size: 13px;
            color: #8B7E74;
            margin-bottom: 24px;
            font-style: italic;
            text-align: center;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* RESPONSIVE: 2 columns on desktop for options */
        @media (min-width: 768px) {
            .options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
        }

        .option {
            background: white;
            border: 2px solid transparent;
            padding: 20px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .option:hover {
            border-color: #3A3632;
            transform: translateX(4px);
        }

        /* RESPONSIVE: Scale up on hover for desktop */
        @media (min-width: 768px) {
            .option:hover {
                transform: scale(1.02);
            }
        }

        .custom-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #E8DFD0;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
            background: white;
        }

        .custom-input:focus {
            outline: none;
            border-color: #3A3632;
        }

        .custom-input-container {
            margin-top: 24px;
        }

        .send-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3A3632 0%, #2A2623 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 54, 50, 0.25);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .insight-bar {
            margin-top: 32px;
            padding: 16px;
            background: rgba(139, 126, 116, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: #5A524C;
            text-align: center;
        }

        /* REVEAL */
        .reveal-screen {
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }

        .reveal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
        }

        /* RESPONSIVE: Wider reveal on desktop */
        @media (min-width: 768px) {
            .reveal-container {
                max-width: 800px;
            }
        }

        @media (min-width: 1024px) {
            .reveal-container {
                max-width: 900px;
            }
        }

        .reveal-label {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #3A3632;
        }

        /* RESPONSIVE: Bigger reveal label on desktop */
        @media (min-width: 768px) {
            .reveal-label {
                font-size: 36px;
            }
        }

        .reveal-analysis {
            font-size: 18px;
            line-height: 1.8;
            color: #5A524C;
            margin-bottom: 48px;
            padding: 32px;
            background: white;
            border-radius: 16px;
        }

        .gifts-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .gift {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .gift-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .gift-why {
            font-size: 16px;
            line-height: 1.6;
            color: #5A524C;
            margin-bottom: 12px;
        }

        .gift-price {
            font-size: 20px;
            font-weight: 600;
            color: #8B7E74;
        }

        .gift-button {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #3A3632 0%, #2A2623 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .gift-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 54, 50, 0.25);
        }

        .direct-link-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        /* FEEDBACK SECTION (NEW) */
        .feedback-section {
            margin-top: 48px;
            padding: 32px;
            background: rgba(139, 126, 116, 0.1);
            border-radius: 16px;
        }

        .feedback-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }

        .accuracy-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .accuracy-btn {
            padding: 12px 32px;
            border: 2px solid #3A3632;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .accuracy-btn:hover {
            background: #3A3632;
            color: white;
        }

        .accuracy-btn.selected {
            background: #3A3632;
            color: white;
        }

        .gift-rating {
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .gift-rating-name {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .rating-buttons {
            display: flex;
            gap: 12px;
        }

        .rating-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #E8DFD0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            border-color: #3A3632;
            transform: scale(1.05);
        }

        .rating-btn.selected {
            border-color: #3A3632;
            background: #FAF7F2;
        }

        .submit-feedback-btn {
            width: 100%;
            margin-top: 24px;
        }

        /* REFINEMENT SECTION */
        .refinement-section {
            margin: 40px 0;
            padding: 32px;
            background: rgba(58, 54, 50, 0.03);
            border-radius: 16px;
            border: 2px dashed #E8DFD0;
        }

        .refinement-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #3A3632;
        }

        .refinement-subtitle {
            font-size: 15px;
            color: #8B7E74;
            margin-bottom: 16px;
        }

        .refinement-input {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: 2px solid #E8DFD0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 16px;
            background: white;
        }

        .refinement-input:focus {
            outline: none;
            border-color: #3A3632;
        }

        .refinement-btn {
            width: 100%;
            background: linear-gradient(135deg, #8B7E74 0%, #6B5F54 100%);
            padding: 16px;
        }

        .refinement-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* LOADING SPINNER */
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(58, 54, 50, 0.1);
            border-top-color: #3A3632;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #5A524C;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div class="screen active" id="introScreen">
        <div class="intro-screen">
            <div class="brand">Giftinator</div>
            <div class="tagline">Powered by Nara</div>
            <p class="subtitle" id="randomSubtitle"></p>
            <button onclick="startDemo()">Begin</button>
        </div>
    </div>

    <!-- LOADING -->
    <div class="screen" id="loadingScreen">
        <div class="intro-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Thinking...</div>
        </div>
    </div>

    <!-- QUIZ -->
    <div class="screen" id="quizScreen">
        <div class="quiz-screen">
            <div class="question-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="question-text" id="questionText"></div>
                <div class="helper-text" id="helperText">üí° Tip: The more specific you are, the better Nara's recommendations</div>
                <div class="options" id="optionsContainer"></div>
                <div class="custom-input-container" id="customInputContainer" style="display: none;">
                    <textarea 
                        class="custom-input" 
                        id="customInput" 
                        placeholder="Be specific! Details like 'they stress-clean at 2am' or 'obsessed with earth tones' help Nara nail it..."
                        rows="4"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="submitCustomAnswer()">
                        Send ‚Üí
                    </button>
                </div>
                <div class="insight-bar" id="insight"></div>
            </div>
        </div>
    </div>

    <!-- REVEAL -->
    <div class="screen" id="revealScreen">
        <div class="reveal-screen">
            <div class="reveal-container">
                <div class="reveal-label" id="revealLabel"></div>
                <div class="reveal-analysis" id="revealAnalysis"></div>
                
                <div class="gifts-header">Here's what they need.</div>
                <div id="giftsContainer"></div>

                <!-- REFINEMENT SECTION (NEW) -->
                <div class="refinement-section" id="refinementSection">
                    <div class="refinement-title">Not quite right?</div>
                    <p class="refinement-subtitle">Tell me what you're looking for and I'll find better options.</p>
                    <textarea 
                        class="refinement-input" 
                        id="refinementInput" 
                        placeholder="e.g., 'Too expensive, need something under $50' or 'They already have a weighted blanket, need different cozy items'"
                    ></textarea>
                    <button class="refinement-btn" onclick="refineGifts()">Get Better Suggestions</button>
                </div>

                <!-- FEEDBACK SECTION -->
                <div class="feedback-section">
                    <div class="feedback-title">Was this accurate?</div>
                    
                    <div class="accuracy-buttons">
                        <button class="accuracy-btn" onclick="selectAccuracy('spot-on')">
                            üëç Spot on
                        </button>
                        <button class="accuracy-btn" onclick="selectAccuracy('missed')">
                            üëé Missed the mark
                        </button>
                    </div>

                    <div id="giftRatingsContainer"></div>

                    <button class="submit-feedback-btn" onclick="submitFeedback()">
                        Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = 'https://giftinator-backend-production.up.railway.app';
        const AFFILIATE_TAG = 'giftinator-20';

        // STATE
        let answers = [];
        let questionHistory = []; // Track Q&A pairs to prevent loops
        let currentReveal = null;
        let refinementMode = false;
        let refinementFeedback = '';
        let refinementAnswers = [];
        let currentQuestion = '';
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // If mobile, try to force browser instead of app
        if (isMobile) {
            console.log('üì± Mobile device detected - using app-compatible links');
        }
        let feedbackData = {
            accuracy: null,
            giftRatings: []
        };

        // Random greetings
        const greetings = [
            "I know people better than their therapist does",
            "About to read them like a book",
            "Your shortcut to the perfect gift",
            "Better than stalking their Instagram for clues",
            "10 questions. Zero gift-giving anxiety"
        ];

        // Dynamic loading messages - picks based on context
        function getLoadingMessage(context, metadata = {}) {
            const messages = {
                earlyQuestions: [
                    "Reading between the lines...",
                    "Connecting the dots...",
                    "Getting to know them..."
                ],
                midQuestions: [
                    "Building their profile...",
                    "Decoding their vibe...",
                    "Mapping their personality..."
                ],
                lateQuestions: [
                    "Almost there...",
                    "Piecing it together...",
                    "Refining the details..."
                ],
                generatingReveal: [
                    "Generating your cheat sheet...",
                    "Finding the perfect matches...",
                    "Cracking the code...",
                    "Putting it all together...",
                    "Finalizing their profile..."
                ],
                refinementQuestions: [
                    "Recalibrating recommendations...",
                    "Digging deeper...",
                    "Getting more specific..."
                ],
                refinementReveal: [
                    "Finding better options...",
                    "Adjusting the algorithm...",
                    "Searching for alternatives..."
                ]
            };

            const contextMessages = messages[context] || ["Thinking..."];
            return contextMessages[Math.floor(Math.random() * contextMessages.length)];
        }

        // Sassy insights
        const sassyInsights = [
            "Ohhh so she's a control freak when stressed. Clocked it.",
            "Wait he's literally a golden retriever boyfriend? Obsessed.",
            "So she talks about self-care but does... none of it? Interesting.",
            "Hold on - burned out but won't admit it? Classic.",
            "Gaming every night but doesn't enjoy it? He's running from something.",
            "She used to love it and now it's a grind? Saw that coming.",
            "Corporate girl who's over it. Got it.",
            "So he avoids feelings through productivity? The math is mathing.",
            "Clocked it - she's the 'I'm fine' type who's absolutely not fine.",
            "Wait she cleans at 2am? That's literally a cry for help.",
            "Golden retriever energy confirmed. Obsessed.",
            "Wellness aesthetic but no actual wellness? Be so for real.",
            "So he's good at his job but hates it? That's the whole vibe.",
            "She isolates when stressed? Not surprised.",
            "Ohhh so he's the 'I don't need help' type. Classic."
        ];

        function getSassyInsight() {
            return sassyInsights[Math.floor(Math.random() * sassyInsights.length)];
        }

        // Set random greeting
        document.getElementById('randomSubtitle').innerHTML = greetings[Math.floor(Math.random() * greetings.length)];

        // Generate Amazon link (fallback if backend doesn't provide real URL)
        function generateAmazonLink(searchQuery) {
            const baseUrl = 'https://www.amazon.com/s';
            const params = new URLSearchParams({
                k: searchQuery,
                tag: AFFILIATE_TAG,
                linkCode: 'll2',  // Affiliate link code for search
                ref: 'nb_sb_noss'  // Referrer code
            });
            return `${baseUrl}?${params.toString()}`;
        }

        // Start quiz
        async function startDemo() {
            showScreen('quizScreen');
            answers = [];
            questionHistory = []; // Reset question history
            await getNextQuestion();
        }

        // Get next question OR trigger reveal
        async function getNextQuestion() {
            try {
                showScreen('loadingScreen');
                
                // Dynamic loading message based on progress
                let loadingContext;
                if (answers.length <= 4) {
                    loadingContext = 'earlyQuestions';
                } else if (answers.length <= 10) {
                    loadingContext = 'midQuestions';
                } else {
                    loadingContext = 'lateQuestions';
                }
                
                document.getElementById('loadingText').textContent = getLoadingMessage(loadingContext);
                
                // If we have 15 answers, call reveal endpoint
                if (answers.length >= 15) {
                    await getReveal();
                    return;
                }
                
                // Otherwise get next question
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 90000); // 90 second timeout - plenty of buffer
                
                const response = await fetch(`${API_URL}/api/next-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        answers: answers,
                        questionHistory: questionHistory // Send Q&A pairs to prevent loops
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                showScreen('quizScreen');
                displayQuestion(data);
                
            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    alert('Request timed out. Please try again.');
                } else {
                    alert('Error connecting to server: ' + error.message);
                }
                showScreen('introScreen');
            }
        }
        
        // Get reveal (separate endpoint)
        async function getReveal() {
            try {
                showScreen('loadingScreen');
                document.getElementById('loadingText').textContent = getLoadingMessage('generatingReveal');
                
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 90000); // 90 second timeout for reveal
                
                const response = await fetch(`${API_URL}/api/reveal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.reveal) {
                    throw new Error('Invalid response from reveal endpoint');
                }
                
                showReveal(data);
                
            } catch (error) {
                console.error('Reveal error:', error);
                if (error.name === 'AbortError') {
                    alert('Profile generation timed out. Your answers were complex! Try again.');
                } else {
                    alert('Error generating profile: ' + error.message);
                }
                showScreen('introScreen');
            }
        }

        // Display question
        function displayQuestion(data) {
            currentQuestion = data.question; // Store question for history
            document.getElementById('questionText').textContent = data.question;
            
            const optionsContainer = document.getElementById('optionsContainer');
            const customInputContainer = document.getElementById('customInputContainer');
            const customInput = document.getElementById('customInput');
            
            // Special handling for Q1 (name) - text input only, no options
            if (data.questionNumber === 1 || !data.options || data.options.length === 0) {
                optionsContainer.innerHTML = '';
                optionsContainer.style.display = 'none';
                customInputContainer.style.display = 'block';
                customInput.value = '';
                customInput.placeholder = 'Type their name...';
                customInput.focus();
            } else {
                // Normal questions with options
                optionsContainer.style.display = 'grid';
                customInputContainer.style.display = 'none';
                customInput.value = '';
                optionsContainer.innerHTML = '';

                data.options.forEach((option, index) => {
                    const div = document.createElement('div');
                    div.className = 'option';
                    div.textContent = option;
                    
                    if (option.includes('None of these')) {
                        div.onclick = () => {
                            optionsContainer.style.display = 'none';
                            customInputContainer.style.display = 'block';
                            
                            // Dynamic placeholder based on question type
                            const placeholders = [
                                "The more specific, the better! Think: 'They meal prep every Sunday but hate it' level detail...",
                                "Give me the real tea! Like 'stress-scrolls Instagram at 2am' or 'obsessed with minimalist vibes'...",
                                "Be specific! Examples: 'wants to paint but never starts' or 'their apartment is freezing'...",
                                "Details matter! Think: 'crashes hard around 7pm' or 'won't spend money on themselves'..."
                            ];
                            customInput.placeholder = placeholders[Math.floor(Math.random() * placeholders.length)];
                            customInput.focus();
                        };
                    } else {
                        div.onclick = () => selectAnswer(option);
                    }
                    
                    optionsContainer.appendChild(div);
                });
            }

            // Update progress
            const progressPercent = refinementMode 
                ? ((15 + data.questionNumber) / 20) * 100 
                : (data.questionNumber / 15) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            
            // Update insight
            document.getElementById('insight').textContent = data.psychologicalInsights 
                ? `Confidence: ${data.confidenceScore}% ¬∑ ${data.psychologicalInsights}`
                : '';

            // Handle custom input enter key (still works)
            customInput.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && customInput.value.trim()) {
                    e.preventDefault();
                    submitCustomAnswer();
                }
            };
        }

        // Submit custom answer via button or Enter key
        function submitCustomAnswer() {
            const customInput = document.getElementById('customInput');
            const answer = customInput.value.trim();
            
            if (answer) {
                selectAnswer(answer);
            }
        }

        // Select answer
        function selectAnswer(answer) {
            if (refinementMode) {
                // In refinement mode - add to refinement answers
                refinementAnswers.push(answer);
                
                if (refinementAnswers.length >= 5) {
                    // After 5 refinement questions, generate new gifts
                    getRefinedReveal();
                } else {
                    // Get next refinement question
                    getRefinementQuestion();
                }
            } else {
                // Normal mode - add to main answers AND question history
                answers.push(answer);
                questionHistory.push({
                    question: currentQuestion,
                    answer: answer
                });
                
                getNextQuestion();
            }
        }

        // Show reveal
        function showReveal(data) {
            currentReveal = data;
            showScreen('revealScreen');
            
            // V4 SCHEMA: archetype, archetypeTagline, personaSnapshot
            document.getElementById('revealLabel').textContent = data.archetype || 'Your Person';
            document.getElementById('revealAnalysis').textContent = data.personaSnapshot || data.archetypeTagline || '';

            const giftsContainer = document.getElementById('giftsContainer');
            giftsContainer.innerHTML = data.gifts.map(gift => {
                // V4 SCHEMA: Use real Amazon URL from backend
                const amazonLink = gift.amazonUrl || generateAmazonLink(gift.amazonSearch);
                
                return `
                    <div class="gift">
                        <div class="gift-name">${gift.giftName}</div>
                        <div class="gift-why">${gift.whyItsPerfect}</div>
                        ${gift.isDirectLink ? '<div class="direct-link-badge">‚úì Direct product link</div>' : ''}
                        <a href="${amazonLink}" 
                           target="_blank"
                           rel="noopener noreferrer nofollow"
                           class="gift-button"
                           onclick="trackClick('${gift.giftName}', '${data.archetype}'); return handleAmazonClick(event, '${amazonLink}');">
                            Find on Amazon ‚Üí
                        </a>
                    </div>
                `;
            }).join('');

            // Show/hide refinement section
            const refinementSection = document.getElementById('refinementSection');
            if (data.isRefinement) {
                refinementSection.style.display = 'none'; // Hide after refinement
            } else {
                refinementSection.style.display = 'block'; // Show on first reveal
            }

            // Setup gift ratings
            const ratingsContainer = document.getElementById('giftRatingsContainer');
            ratingsContainer.innerHTML = data.gifts.map((gift, index) => `
                <div class="gift-rating">
                    <div class="gift-rating-name">${gift.giftName}</div>
                    <div class="rating-buttons">
                        <button class="rating-btn" onclick="rateGift(${index}, 'love')">‚ù§Ô∏è</button>
                        <button class="rating-btn" onclick="rateGift(${index}, 'neutral')">üòê</button>
                        <button class="rating-btn" onclick="rateGift(${index}, 'dislike')">üëé</button>
                    </div>
                </div>
            `).join('');

            feedbackData.giftRatings = data.gifts.map(g => ({ name: g.giftName, rating: null }));
            feedbackData.archetype = data.archetype;
        }

        // Start refinement flow - ask for feedback first
        async function refineGifts() {
            try {
                const refinementInput = document.getElementById('refinementInput');
                const feedback = refinementInput.value.trim();
                
                if (!feedback || feedback.length < 10) {
                    alert('Please tell me more specifically what you\'re looking for (at least 10 characters).');
                    return;
                }
                
                // Save feedback and enter refinement mode
                refinementFeedback = feedback;
                refinementAnswers = [];
                refinementMode = true;
                
                // Clear input
                refinementInput.value = '';
                
                // Get first refinement question
                await getRefinementQuestion();
                
            } catch (error) {
                console.error('Refinement start error:', error);
                alert('Error starting refinement: ' + error.message);
            }
        }

        // Get refinement question (1-5)
        async function getRefinementQuestion() {
            try {
                showScreen('loadingScreen');
                document.getElementById('loadingText').textContent = getLoadingMessage('refinementQuestions');
                
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 90000); // 90 second timeout
                
                const response = await fetch(`${API_URL}/api/refine-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        answers: answers,
                        previousReveal: currentReveal,
                        refinementFeedback: refinementFeedback,
                        refinementAnswers: refinementAnswers
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                showScreen('quizScreen');
                displayQuestion(data);
                
                // Update progress bar for refinement (show as 16-20)
                const totalProgress = 15 + data.questionNumber;
                document.getElementById('progressFill').style.width = `${(totalProgress / 20) * 100}%`;
                
            } catch (error) {
                console.error('Refinement question error:', error);
                alert('Error getting refinement question: ' + error.message);
                showScreen('revealScreen');
                refinementMode = false;
            }
        }

        // Get refined reveal after 5 questions
        async function getRefinedReveal() {
            try {
                showScreen('loadingScreen');
                document.getElementById('loadingText').textContent = getLoadingMessage('refinementReveal');
                
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 60000);
                
                const response = await fetch(`${API_URL}/api/refine-reveal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        answers: answers,
                        previousReveal: currentReveal,
                        refinementFeedback: refinementFeedback,
                        refinementAnswers: refinementAnswers
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Exit refinement mode
                refinementMode = false;
                refinementFeedback = '';
                refinementAnswers = [];
                
                showReveal(data);
                
            } catch (error) {
                console.error('Refined reveal error:', error);
                if (error.name === 'AbortError') {
                    alert('Request timed out. Please try again.');
                } else {
                    alert('Error generating refined gifts: ' + error.message);
                }
                showScreen('revealScreen');
                refinementMode = false;
            }
        }

        // Handle Amazon link clicks - optimize for browser over app
        function handleAmazonClick(event, url) {
            // On mobile, try to keep in browser instead of opening app
            if (isMobile) {
                // Strategy: Open in same window on mobile to avoid app trigger
                // User can use back button to return
                event.preventDefault();
                window.location.href = url;
                return false;
            }
            // On desktop, let it open in new tab normally
            return true;
        }

        // Track click
        function trackClick(giftName, searchQuery) {
            fetch(`${API_URL}/api/track-click`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    giftName: giftName,
                    searchQuery: searchQuery,
                    archetype: currentReveal.personalityLabel,
                    timestamp: new Date()
                })
            }).catch(err => console.log('Tracking failed:', err));
        }

        // Select accuracy
        function selectAccuracy(type) {
            feedbackData.accuracy = type;
            document.querySelectorAll('.accuracy-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        // Rate gift
        function rateGift(index, rating) {
            feedbackData.giftRatings[index].rating = rating;
            const buttons = event.target.parentElement.querySelectorAll('.rating-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Submit feedback
        function submitFeedback() {
            if (!feedbackData.accuracy) {
                alert('Please rate the accuracy first!');
                return;
            }

            fetch(`${API_URL}/api/submit-feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    archetype: currentReveal.personalityLabel,
                    accuracy: feedbackData.accuracy,
                    giftRatings: feedbackData.giftRatings,
                    timestamp: new Date()
                })
            }).then(() => {
                alert('Thank you! Your feedback helps Nara learn.');
            }).catch(err => {
                console.log('Feedback failed:', err);
                alert('Feedback saved locally (server offline)');
            });
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
    </script>
</body>
</html>
