<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giftinator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #FAF7F2 0%, #F5EFE6 100%);
            color: #3A3632;
            min-height: 100vh;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 40px 24px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* INTRO */
        .intro-screen {
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        .brand {
            font-family: 'Cormorant Garamond', serif;
            font-size: 56px;
            font-weight: 700;
            color: #3A3632;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 15px;
            color: #8B7E74;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 24px;
        }

        .subtitle {
            font-size: 18px;
            line-height: 1.6;
            color: #5A524C;
            margin-bottom: 40px;
        }

        button {
            background: linear-gradient(135deg, #3A3632 0%, #2A2623 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 54, 50, 0.25);
        }

        /* QUIZ */
        .quiz-screen {
            justify-content: center;
            align-items: center;
        }

        .question-container {
            max-width: 600px;
            width: 100%;
        }

        .progress-bar {
            height: 4px;
            background: rgba(58, 54, 50, 0.1);
            border-radius: 2px;
            margin-bottom: 32px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B7E74, #3A3632);
            transition: width 0.4s ease;
        }

        .question-text {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 32px;
            line-height: 1.4;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            background: white;
            border: 2px solid transparent;
            padding: 20px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .option:hover {
            border-color: #3A3632;
            transform: translateX(4px);
        }

        .custom-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #E8DFD0;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            margin-top: 12px;
        }

        .insight-bar {
            margin-top: 32px;
            padding: 16px;
            background: rgba(139, 126, 116, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: #5A524C;
            text-align: center;
        }

        /* REVEAL */
        .reveal-screen {
            justify-content: flex-start;
            align-items: center;
        }

        .reveal-container {
            max-width: 700px;
            width: 100%;
        }

        .reveal-label {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #3A3632;
        }

        .reveal-analysis {
            font-size: 18px;
            line-height: 1.8;
            color: #5A524C;
            margin-bottom: 48px;
            padding: 32px;
            background: white;
            border-radius: 16px;
        }

        .gifts-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .gift {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .gift-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .gift-why {
            font-size: 16px;
            line-height: 1.6;
            color: #5A524C;
            margin-bottom: 12px;
        }

        .gift-price {
            font-size: 20px;
            font-weight: 600;
            color: #8B7E74;
        }

        .gift-button {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #3A3632 0%, #2A2623 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .gift-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 54, 50, 0.25);
        }

        /* FEEDBACK SECTION (NEW) */
        .feedback-section {
            margin-top: 48px;
            padding: 32px;
            background: rgba(139, 126, 116, 0.1);
            border-radius: 16px;
        }

        .feedback-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }

        .accuracy-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .accuracy-btn {
            padding: 12px 32px;
            border: 2px solid #3A3632;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .accuracy-btn:hover {
            background: #3A3632;
            color: white;
        }

        .accuracy-btn.selected {
            background: #3A3632;
            color: white;
        }

        .gift-rating {
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .gift-rating-name {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .rating-buttons {
            display: flex;
            gap: 12px;
        }

        .rating-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #E8DFD0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            border-color: #3A3632;
            transform: scale(1.05);
        }

        .rating-btn.selected {
            border-color: #3A3632;
            background: #FAF7F2;
        }

        .submit-feedback-btn {
            width: 100%;
            margin-top: 24px;
        }

        /* LOADING SPINNER */
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(58, 54, 50, 0.1);
            border-top-color: #3A3632;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #5A524C;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div class="screen active" id="introScreen">
        <div class="intro-screen">
            <div class="brand">Giftinator</div>
            <div class="tagline">Powered by Nara</div>
            <p class="subtitle" id="randomSubtitle"></p>
            <button onclick="startDemo()">Begin</button>
        </div>
    </div>

    <!-- LOADING -->
    <div class="screen" id="loadingScreen">
        <div class="intro-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Thinking...</div>
        </div>
    </div>

    <!-- QUIZ -->
    <div class="screen" id="quizScreen">
        <div class="quiz-screen">
            <div class="question-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="question-text" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
                <textarea 
                    class="custom-input" 
                    id="customInput" 
                    placeholder="Type your answer here..."
                    style="display: none;"
                ></textarea>
                <div class="insight-bar" id="insight"></div>
            </div>
        </div>
    </div>

    <!-- REVEAL -->
    <div class="screen" id="revealScreen">
        <div class="reveal-screen">
            <div class="reveal-container">
                <div class="reveal-label" id="revealLabel"></div>
                <div class="reveal-analysis" id="revealAnalysis"></div>
                
                <div class="gifts-header">Here's what they need.</div>
                <div id="giftsContainer"></div>

                <!-- FEEDBACK SECTION (NEW) -->
                <div class="feedback-section">
                    <div class="feedback-title">Was this accurate?</div>
                    
                    <div class="accuracy-buttons">
                        <button class="accuracy-btn" onclick="selectAccuracy('spot-on')">
                            üëç Spot on
                        </button>
                        <button class="accuracy-btn" onclick="selectAccuracy('missed')">
                            üëé Missed the mark
                        </button>
                    </div>

                    <div id="giftRatingsContainer"></div>

                    <button class="submit-feedback-btn" onclick="submitFeedback()">
                        Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = 'https://giftinator-backend-production.up.railway.app';
        const AFFILIATE_TAG = 'yourname-20'; // ‚Üê CHANGE THIS

        // STATE
        let answers = [];
        let currentReveal = null;
        let feedbackData = {
            accuracy: null,
            giftRatings: []
        };

        // Random greetings
        const greetings = [
            "I'll read them better than you do. Obsessed.",
            "8-10 questions. Zero guessing. It's giving psychic energy.",
            "Your sign to stop guessing what they actually want.",
            "I'll tell you what they need. Be so for real right now.",
            "Literally better than asking their best friend.",
            "Gift giving but make it main character energy.",
            "Stop buying random stuff. Let me read them first.",
            "The vibe check they didn't know they needed.",
            "Obsessed with how accurate this gets."
        ];

        // Sassy insights
        const sassyInsights = [
            "Ohhh so she's a control freak when stressed. Clocked it.",
            "Wait he's literally a golden retriever boyfriend? Obsessed.",
            "So she talks about self-care but does... none of it? Interesting.",
            "Hold on - burned out but won't admit it? Classic.",
            "Gaming every night but doesn't enjoy it? He's running from something.",
            "She used to love it and now it's a grind? Saw that coming.",
            "Corporate girl who's over it. Got it.",
            "So he avoids feelings through productivity? The math is mathing.",
            "Clocked it - she's the 'I'm fine' type who's absolutely not fine.",
            "Wait she cleans at 2am? That's literally a cry for help.",
            "Golden retriever energy confirmed. Obsessed.",
            "Wellness aesthetic but no actual wellness? Be so for real.",
            "So he's good at his job but hates it? That's the whole vibe.",
            "She isolates when stressed? Not surprised.",
            "Ohhh so he's the 'I don't need help' type. Classic."
        ];

        function getSassyInsight() {
            return sassyInsights[Math.floor(Math.random() * sassyInsights.length)];
        }

        // Set random greeting
        document.getElementById('randomSubtitle').innerHTML = greetings[Math.floor(Math.random() * greetings.length)];

        // Generate Amazon link
        function generateAmazonLink(searchQuery) {
            const baseUrl = 'https://www.amazon.com/s';
            const params = new URLSearchParams({
                k: searchQuery,
                tag: AFFILIATE_TAG,
                linkCode: 'll2'
            });
            return `${baseUrl}?${params.toString()}`;
        }

        // Start quiz
        async function startDemo() {
            showScreen('quizScreen');
            answers = [];
            await getNextQuestion();
        }

        // Get next question OR trigger reveal
        async function getNextQuestion() {
            try {
                showScreen('loadingScreen');
                document.getElementById('loadingText').textContent = 'Analyzing...';
                
                // If we have 15 answers, call reveal endpoint
                if (answers.length >= 15) {
                    await getReveal();
                    return;
                }
                
                // Otherwise get next question
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch(`${API_URL}/api/next-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                showScreen('quizScreen');
                displayQuestion(data);
                
            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    alert('Request timed out. Please try again.');
                } else {
                    alert('Error connecting to server: ' + error.message);
                }
                showScreen('introScreen');
            }
        }
        
        // Get reveal (separate endpoint)
        async function getReveal() {
            try {
                showScreen('loadingScreen');
                document.getElementById('loadingText').textContent = 'Generating your profile...';
                
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 60000); // 60 second timeout for reveal
                
                const response = await fetch(`${API_URL}/api/reveal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.reveal) {
                    throw new Error('Invalid response from reveal endpoint');
                }
                
                showReveal(data);
                
            } catch (error) {
                console.error('Reveal error:', error);
                if (error.name === 'AbortError') {
                    alert('Profile generation timed out. Your answers were complex! Try again.');
                } else {
                    alert('Error generating profile: ' + error.message);
                }
                showScreen('introScreen');
            }
        }

        // Display question
        function displayQuestion(data) {
            document.getElementById('questionText').textContent = data.question;
            document.getElementById('progressFill').style.width = `${(data.questionNumber / 10) * 100}%`;
            document.getElementById('insight').textContent = `Confidence: ${data.confidenceScore}% ¬∑ ${data.psychologicalInsights}`;

            const optionsContainer = document.getElementById('optionsContainer');
            const customInput = document.getElementById('customInput');
            
            optionsContainer.innerHTML = '';
            customInput.style.display = 'none';
            customInput.value = '';

            data.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = option;
                
                if (option.includes('None of these')) {
                    div.onclick = () => {
                        customInput.style.display = 'block';
                        customInput.focus();
                    };
                } else {
                    div.onclick = () => selectAnswer(option);
                }
                
                optionsContainer.appendChild(div);
            });

            // Handle custom input
            customInput.onkeypress = (e) => {
                if (e.key === 'Enter' && customInput.value.trim()) {
                    selectAnswer(customInput.value.trim());
                }
            };
        }

        // Select answer
        function selectAnswer(answer) {
            answers.push(answer);
            getNextQuestion();
        }

        // Show reveal
        function showReveal(data) {
            currentReveal = data;
            showScreen('revealScreen');
            
            // V4 SCHEMA: archetype, archetypeTagline, personaSnapshot
            document.getElementById('revealLabel').textContent = data.archetype || 'Your Person';
            document.getElementById('revealAnalysis').textContent = data.personaSnapshot || data.archetypeTagline || '';

            const giftsContainer = document.getElementById('giftsContainer');
            giftsContainer.innerHTML = data.gifts.map(gift => {
                // V4 SCHEMA: gift.amazonSearch (not searchQuery)
                const amazonLink = generateAmazonLink(gift.amazonSearch);
                
                return `
                    <div class="gift">
                        <div class="gift-name">${gift.giftName}</div>
                        <div class="gift-why">${gift.whyItsPerfect}</div>
                        <a href="${amazonLink}" 
                           target="_blank" 
                           class="gift-button"
                           onclick="trackClick('${gift.giftName}', '${data.archetype}')">
                            Find on Amazon ‚Üí
                        </a>
                    </div>
                `;
            }).join('');

            // Setup gift ratings
            const ratingsContainer = document.getElementById('giftRatingsContainer');
            ratingsContainer.innerHTML = data.gifts.map((gift, index) => `
                <div class="gift-rating">
                    <div class="gift-rating-name">${gift.giftName}</div>
                    <div class="rating-buttons">
                        <button class="rating-btn" onclick="rateGift(${index}, 'love')">‚ù§Ô∏è</button>
                        <button class="rating-btn" onclick="rateGift(${index}, 'neutral')">üòê</button>
                        <button class="rating-btn" onclick="rateGift(${index}, 'dislike')">üëé</button>
                    </div>
                </div>
            `).join('');

            feedbackData.giftRatings = data.gifts.map(g => ({ name: g.giftName, rating: null }));
            feedbackData.archetype = data.archetype;
        }

        // Track click
        function trackClick(giftName, searchQuery) {
            fetch(`${API_URL}/api/track-click`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    giftName: giftName,
                    searchQuery: searchQuery,
                    archetype: currentReveal.personalityLabel,
                    timestamp: new Date()
                })
            }).catch(err => console.log('Tracking failed:', err));
        }

        // Select accuracy
        function selectAccuracy(type) {
            feedbackData.accuracy = type;
            document.querySelectorAll('.accuracy-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        // Rate gift
        function rateGift(index, rating) {
            feedbackData.giftRatings[index].rating = rating;
            const buttons = event.target.parentElement.querySelectorAll('.rating-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Submit feedback
        function submitFeedback() {
            if (!feedbackData.accuracy) {
                alert('Please rate the accuracy first!');
                return;
            }

            fetch(`${API_URL}/api/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    archetype: currentReveal.personalityLabel,
                    accuracy: feedbackData.accuracy,
                    giftRatings: feedbackData.giftRatings,
                    timestamp: new Date()
                })
            }).then(() => {
                alert('Thank you! Your feedback helps Nara learn.');
            }).catch(err => {
                console.log('Feedback failed:', err);
                alert('Feedback saved locally (server offline)');
            });
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
    </script>
</body>
</html>
